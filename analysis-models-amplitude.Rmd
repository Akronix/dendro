---
title: "analysis-models-amplitude"
author: "Abel Serrano Juste"
date: "`r Sys.Date()`"
output: html_document
---

# INITIALIZATION
SET GLOBAL VARS
```{r}
PATH = dirname(rstudioapi::getSourceEditorContext()$path)
print(PATH)
setwd(PATH)
```

Import libraries
```{r}
require(visreg)
library(ggnewscale)
library(tidyverse)
```

Load amplitude data set for each site
```{r}
ampl.df <- read.csv(file.path('cooked-data', 'amplitudeAndClimate-allsites.csv'))
summary(ampl.df)
```

Convert categorical variables to R "factor"
```{r}
ampl.df <- ampl.df %>% mutate_at (vars(site, class, series), \(x) {as.factor(x)}) %>% mutate(date = as.Date(date)) %>% dplyr::rename(id = series)
str(ampl.df)
```

Create one different dataframe for every class
```{r}
amplitude.Qi <- ampl.df[ampl.df$class == "Quercus",]
amplitude.P_ND <- ampl.df[ampl.df$class == "ND",]
amplitude.P_D <- ampl.df[ampl.df$class == "D",]
```


## VISUALIZATION

Plot amplitudes:
```{r}
# library(ggnewscale)
# # Define color scales for each class
# green_colors <- c("lightgreen", "green", "darkgreen", "darkolivegreen", "olivedrab", "springgreen")
# blue_colors <- c("blue", "cyan", "aquamarine", "cadetblue", "dodgerblue", "darkblue")
# orange_colors <- c("orange", "orangered", "tomato", "darkorange", "coral", "tan")

ggplot() +
  ggtitle("Amplitudes painted by color scale according to its group") +
  geom_line(data = amplitude.P_D, aes(x = date, y = ampl, col = id)) +
  # scale_color_manual(values = orange_colors, name = "Declining trees") +
  # new_scale_color() +
  geom_line(data = amplitude.P_ND, aes(x = date, y = ampl, col = id), ) +
  # scale_color_manual(values = blue_colors, name = "Non-Declining trees") +
  # new_scale_color() +
  geom_line(data = amplitude.Qi, aes(x = date, y = ampl, col = id)) +
  # scale_color_manual(values = green_colors, name = "Quercus Ilex") +
  labs(x=expression(''),
       y=expression(Delta*" D (um)")) +
  scale_x_date(date_breaks = "1 month", date_labels="%b %Y") +
  theme(axis.text.x = element_text(angle = 30, hjust=1))
```

```{r}
boxplot(log10(ampl+1) ~ class, data = ampl.df %>% filter(site == "Miedes"))
boxplot(log10(ampl+1) ~ class, data = ampl.df %>% filter(site == "Penaflor"))
boxplot(log10(ampl+1) ~ class, data = ampl.df %>% filter(site == "Corbalan"))
```
^ Threre's homogeinity

```{r}
data <- ampl.df %>% filter(id == first(unique(amplitude.P_D$id)) | id == first(unique(amplitude.Qi$id)) | id == first(unique(amplitude.P_ND$id)))
ggplot() +
  ggtitle("Amplitudes painted by color scale according to its group") +
  geom_line(data = data, aes(x = date, y = ampl, col = id)) +
  scale_x_date(date_breaks = "1 month", date_labels="%b %Y")
```

Plot histograms:
```{r}
for (dendro.no in unique(ampl.df$id)) {
  dat = ampl.df %>% filter(id == dendro.no)
  hist(log10(dat$ampl))
}
```

# Analysis

## ANOVA to explore significant difference between means by class
Analysis ANOVA to see if there's significant difference between the average amplitude of each class

```{r}
aov.model <- aov(ampl ~ class + id, data = ampl.df)
summary(aov.model)
```

```{r}
plot(aov.model$residuals)
```

```{r}
TukeyHSD(aov.model)
```

```{r}
plot(TukeyHSD(aov.model))
```

## LMM
```{r}
library(lme4)
library("bbmle") ## for AICtab
```

Plot climate variables distribution
(cambiar por db.all)
```{r}
par(mfrow=c(3,2),mar=c(2,2,3,2),oma=c(2,3,1,1),xpd=F)
hist(ampl.df$mean.temp)
hist(ampl.df$max.temp)
hist(ampl.df$range.temp)
hist(ampl.df$mean.vwc)
hist(ampl.df$max.vwc)
hist(ampl.df$range.vwc)
```

```{r}
#range.vwc tiene una distribución muy, muy asimetrica. Sería mejor cambiarla por
#factor
#ver la variable respuesta
par(mfrow=c(2,1),mar=c(2,2,3,2),oma=c(2,3,1,1),xpd=F)
hist(ampl.df$ampl)
hist(log10(ampl.df$ampl+0.1))
```

```{r}
model.glm <- glm(log10(ampl+0.1) ~ 1 + id + doy, data = ampl.df, family = "gaussian")
model.glm2 <- glm(ampl ~ 1 + id + doy, data = ampl.df, family = "gamma")
```


```{r}
library(lme4)
model.lme4 <- lmer(log10(ampl+0.1) ~ 1 + (1|id), data = ampl.df)
#model <- lmer(log10(ampl+0.1) ~ 1 + (1|class) + (1|id) + (1|doy) + (1|site), data = ampl.df)
#model <- lmer(log10(ampl+0.1) ~ 1, random = ~ 1 + class + id + doy + site, data = ampl.df)
#model.clim <- lmer(log10(ampl) ~ max.vwc * range.temp + (1|class) + (1|id) + (1|doy) + (1|site) , data = ampl.df)
```

Now using nlme
```{r}
library(nlme)
model.lme <- lme(log10(ampl+1) ~ 1, random = ~ 1|id, data = ampl.df)
model.lme.clim <- lme(log10(ampl+1) ~ mean.temp + max.vwc, random = ~ 1|id, data = ampl.df)
model.lme.autocor <- update(model.lme, correlation=corAR1())
model.lme.clim.ar <- lme(log10(ampl+1) ~ mean.temp + max.vwc, random = ~ 1|id, correlation=corAR1(), data = ampl.df)
model.lme.clim.arI <- lme(log10(ampl+1) ~ mean.temp * max.vwc, random = ~ 1|id, correlation=corAR1(), data = ampl.df)
```

```{r}
plot(ACF(model.lme, resType="normalized", alpha=0.05))
plot(ACF(model.lme.clim,  resType="normalized", alpha=0.05))
plot(ACF(model.lme.clim.ar,  resType="normalized", alpha=0.05))
plot(ACF(model.lme.clim.arI,  resType="normalized", alpha=0.05))
plot(ACF(model.lme.autocor, resType="normalized", alpha=0.05))
```

relations between response variable and explanatory variables
```{r}
plot(log10(ampl+0.1) ~ degree.hours.temp ,ampl.df)
plot(log10(ampl+0.1) ~ max.vwc ,ampl.df)
plot(log10(ampl+0.1) ~ mean.temp ,ampl.df)
cor(ampl.df$degree.hours.temp, ampl.df$mean.temp)
```

```{r}
summary(model.lme.clim.arI)
```
```{r}
plot(model.lme.clim.arI)
```


subset to only Miedes data to have smaller amount of data:
```{r}
a1 <- subset(ampl.df, id == '92222151' | id == '92222152' | id == '92222153')
```

glmmTMB
```{r}
library(glmmTMB)
model.glmmTMB <- glmmTMB(log10(ampl+0.1) ~ 1 + (1|id) + (1|doy), data=ampl.df, family=gaussian) # add up 
model.glmmTMB.cor <- glmmTMB(log10(ampl+0.1) ~ 1 + (1|id)  + (1|doy) + ar1(as.factor(doy)-1|id), data=ampl.df, family=gaussian) # add up temporal autocorrelation
model.glmmTMB2 <- glmmTMB(log10(ampl+0.1) ~ class + site + (1|id) + (1|doy), data=ampl.df, family=gaussian)
model.glmmTMB2.cor <- update(model.glmmTMB2, . ~ . + ar1(as.factor(doy)-1|id))
model.glmmTMB2.climate <- update(model.glmmTMB2.cor,  . ~ . + degree.hours.temp + max.vwc)
```

```{r}
# AICtab(model.glmmTMB, model.glmmTMB.cor, model.glmmTMB2, model.glmmTMB2.cor, model.lme4, model.glm, model.lme, model.lme.autocor, model.lme.clim, model.lme.clim.ar, model.glmmTMB2.climate, weights=TRUE, delta = T, base = T)
AICtab(model.lme, model.lme.autocor, model.lme.clim, model.lme.clim.ar, model.lme.clim.arI, weights=TRUE, delta = T, base = T)
```

```{r}
waic

```



# GAMM
```{r}

```


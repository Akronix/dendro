```{r}
source("lib-dendro.R")

library(ggplot2)
library(dplyr)

### DEFINE GLOBAL VARS ###
PATH = '/home/akronix/workspace/dendro';
setwd(PATH)

DATA_DIR = 'Valcuerna-processed'
FILENAME_EXCESS = "_2023_10_25_0.csv"

# Set initial and final date and sampling dates
ts_start<-"2023-03-23 09:00:00" # 2 days after installation
ts_end<-"2023-10-25 14:45:00" # last timestamp of downloaded data

### IMPORT DENDRO DATA ###

# importing dendro data #
list_files <- list.files(file.path(".",DATA_DIR), pattern="*.csv$", full.names=TRUE)
db<-read.all.processed(list_files)

### CLEAN & PREPARE DATA ###

# INSPECT DATA
str(db)
head(db)
tail(db)
```


```{r}
## PLOT ALL DENDROS ##
plot_multiple_dendro <- function (data, title, y = data$value)  {
  ggplot(data = data, mapping = aes(x=ts, y=y, col=series))+
  geom_line( )+
  # ggtitle(paste0("Dendro data for sensor series: ",db$series[1], " - ", db$sp[1])) +
  labs(x=expression('Date'),
       y=expression( Delta*"D (um)") ) +
  geom_hline(yintercept=0,lty=2,linewidth=0.2)+
  scale_x_datetime(date_breaks = "1 month", date_labels = "%m-%y") +
  ggtitle(title) +
  theme_bw()
}
```

```{r}
plot_multiple_dendro(db, "All raw dendrometers data")
```

```{r}
db = filter(db, series !=  "92232429")
plot_multiple_dendro(db, "All raw dendrometers data")
```

# Normalization 0-1 to better compare dendros

```{r}
normalized.db <- db %>%
  select (series, ts, value) %>%
  group_by(series) %>%
  mutate( normalized_value = normalize.0_1(value), .keep = 'all' )
```


```{r}
plot_multiple_dendro(normalized.db, "Dendros data normalized to [0-1]", y = normalized.db$normalized_value)
```


# Mean + strip region of SE
```{r}
library(Rmisc) # for summarySE()
dbagg <- summarySE(db, measurevar = "value", groupvars = c("ts"), na.rm = TRUE)
head(dbagg)
tail(dbagg)
```

```{r}
plot_cat_full_year<-
  ggplot(data = dbagg,  aes(x=ts, y=value)) +
  ggtitle("Mean of data for dendrometers with ± standard error strips") +
  geom_ribbon(aes(ymin=value-se, ymax=value+se), fill='lightgreen', alpha=0.3, show.legend	= FALSE, linetype = 0) +
  geom_line( aes (linetype = "Quercus Ilex"), col='darkgreen', show.legend	= F) +
  labs(x=expression(''),
       y=expression(Delta*" D (um)"))+
  theme_bw() +
  geom_hline(yintercept=0,lty=2,linewidth=0.2)+
  #facet_grid(class~.,scales = "free_y")+
  scale_x_datetime(date_breaks = "1 month", date_labels="%b %Y") +
  theme(axis.text.x = element_text(angle = 30, hjust=1))
plot_cat_full_year
ggsave('mean+Valcuerna.png', width = 15, height = 10)
```


# By species

```{r}
db.lentiscos <- db %>% filter (series %in% c(92223485, 92232435, 92232429, 92232425, 92232432) )
db.sabinas <- db %>% filter (series %in% c(92232422, 92232436, 92232430, 92232434, 92232433, 92232427, 92232428, 92232431, 92232426))
```

```{r}
db.lentiscos.agg <- summarySE(db.lentiscos, measurevar = "value", groupvars = c("ts"), na.rm = TRUE)
head(db.lentiscos.agg)
tail(db.lentiscos.agg)
```

```{r}
#library(mdthemes)
plot_mean_se <- function (data, species, output_fn = FALSE) {
  plot <-
    ggplot(data = data,  aes(x=ts, y=value)) +
    ggtitle(paste0("Mean of data for ", species, " with ± standard error strips")) +
    geom_ribbon(aes(ymin=value-se, ymax=value+se), fill='lightgreen', alpha=0.3, show.legend	= FALSE, linetype = 0) +
    geom_line( aes (linetype = species), col='darkgreen', show.legend	= T) +
    labs(x=expression(''),
         y=expression(Delta*" D (um)"))+
    theme_bw() +
    geom_hline(yintercept=0,lty=2,linewidth=0.2)+
    #facet_grid(class~.,scales = "free_y")+
    scale_x_datetime(date_breaks = "1 month", date_labels="%b %Y") +
    theme(axis.text.x = element_text(angle = 30, hjust=1))
  plot(plot)
  if (output_fn){
    ggsave(output_fn, width = 15, height = 10)  
  }
}
```


```{r}
plot_mean_se(db.lentiscos.agg, "Pistacia Lentiscus" )
```
```{r}
db.sabinas.agg <- summarySE(db.sabinas, measurevar = "value", groupvars = c("ts"), na.rm = TRUE)
head(db.sabinas.agg)
tail(db.sabinas.agg)
```


```{r}
plot_mean_se(db.sabinas.agg, "Juniperus Phoenicea" )
```

Join both df species in one
```{r}
db.sabinas.agg$class = factor("sabinas")
db.lentiscos.agg$class = factor("lentiscos")
db.sabinasylentiscos = rbind.data.frame(db.sabinas.agg,db.lentiscos.agg)
str(db.sabinasylentiscos)
```

Plot both dendros in one graph
```{r}
plotValcuernaMeans <- 
  ggplot(data = db.sabinasylentiscos,  aes(x=ts, y=value, col=class)) +
    ggtitle("Mean of raw data for Pistacia Lentiscus and Juniperus Phoenicea with ± standard error strips") +
    geom_line() +
    geom_ribbon(aes(ymin=value-se, ymax=value+se, fill=class), alpha=0.2, show.legend	= FALSE, linetype = 0) +
    #geom_line( aes (linetype = "Quercus Ilex"), col='darkgreen', show.legend	= F) +
    labs(x=expression(''),
         y=expression(Delta*" D (um)"))+
    theme_bw() +
    geom_hline(yintercept=0,lty=2,linewidth=0.2)+
    #facet_grid(class~.,scales = "free_y")+
    scale_x_datetime(date_breaks = "1 month", date_labels="%b %Y") +
    theme(axis.text.x = element_text(angle = 30, hjust=1))
plotValcuernaMeans
#ggsave('mean+Valcuerna.png', width = 15, height = 10)
```

# Environmental data from TMS sensors

```{r}
ENV_DIR = 'Valcuerna-Prec-processed'

# importing processed environmental data #
list_files <- list.files(file.path(PATH,ENV_DIR), pattern="*.csv$", full.names=TRUE)
db.env<-read.all.env.processed(list_files)
str(db.env)
```

```{r}
plot_multiple_dendro(db.env, "Volumetric Water Content per TMS sensor", y = db.env$vwc)
```
There's quite a bunch of invalid data (timeframes where the sensor has been removed by an animal), we need to remove those:
```{r}
# 94252893 it's valid only from installation to mid April and then from mid-june to firsts of July
cond1 = db.env$series == "94252893"
# investigating, the first valid period is until "2023-04-13 21:00:00"
#  and second valid period is from 2023-06-11 19:00:00 (very approximated) until 2023-07-05 03:30:00
interval = (aux$ts > "2023-04-13 21:00:00") & (aux$ts <= "2023-06-11 19:00:00") 
db.env[interval & cond1,]$vwc <- NA # first invalid period: from 13 of april to 11 of june.
db.env[interval & cond1,]$temp <- NA # first invalid period: from 13 of april to 11 of june.

db.env[(aux$ts >= "2023-07-05 03:30:00") & cond1,]$vwc <- NA # second invalid period from 2023-07-05 03:30:00 to the end
db.env[(aux$ts >= "2023-07-05 03:30:00") & cond1,]$temp <- NA # second invalid period from 2023-07-05 03:30:00 to the end

# 94252894 it's invalid from mid-August to the end.
cond2 = db.env$series == "94252894"
# investigating, the invalid period starts exactly at 2023-08-18 06:30:00 and it goes until the end:
db.env[(aux$ts >= "2023-08-18 06:30:00") & cond2,]$vwc <- NA
db.env[(aux$ts >= "2023-08-18 06:30:00") & cond2,]$temp <- NA
```

This is the result of adding the NA to the invalid periods:
```{r}
plot_multiple_dendro(db.env, "Volumetric Water Content per TMS sensor", y = db.env$vwc)
```

Now calculate the mean for vwc and temp:
```{r}
db.env.agg = db.env %>% group_by(ts) %>% dplyr::summarise(temp = mean(temp, na.rm = T), vwc = mean(vwc, na.rm = T))
db.env.agg
```


And we plot it:

```{r}
plot_temp_and_humidity <-
  ggplot(data = db.env.agg, aes(x=ts, y=temp)) +
    geom_line(aes(colour = temp)) +
    theme_bw() +
    scale_colour_gradient(low = "light blue", high = "red") +
    scale_x_datetime(date_breaks = "1 month", date_labels="%b %Y") +
    theme(axis.text.x = element_text(angle = 30, hjust=1)) +
    scale_y_continuous("Temperature (ºC)", breaks=seq(0,50,10), sec.axis = dup_axis(name = "Volumetric Water Content (%)" ))+
    geom_line(aes(x = ts, y = vwc * 100,  linetype = "Volumetric Water Content (%)"), col="blue", show.legend	= TRUE) +
    scale_linetype_manual(NULL, values = 1) +
    labs(x=expression(''), colour = "Temperature (ºC)")
plot_temp_and_humidity
```



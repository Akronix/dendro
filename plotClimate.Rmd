---
title: "R Notebook"
output: html_notebook
---

```{r}
source('lib-dendro.R')

library(glue)
library(tidyverse)
library(ggplot2)

theme_set( theme_bw() +
          theme(
            axis.text=element_text(size=12),
            legend.text=element_text(size=10),
            axis.title=element_text(size=14),
            plot.title = element_text(hjust = 0.5, face = "bold")
          ))

### DEFINE GLOBAL VARS ###
PATH = dirname(rstudioapi::getSourceEditorContext()$path)
print(PATH)
setwd(PATH)

PLACE = 'Corbalan'
ENV_DIR = glue('processed/{PLACE}-env-processed')

ts_start <- "2022-05-01"
ts_end   <- "2023-02-28"

# Select TMS serial no for this analysis
SELECTED_TMS <- case_when(  # select one TMS sensor for this site which has all its data valid
  PLACE == 'Miedes' ~ c("94231935"),
  PLACE == 'Corbalan' ~ c("94231943"),
  PLACE == 'Penaflor' ~ c("94231934"), # 94231950 is delayed? and throws wrong results? double check
  .default = NA
)
```


```{r}
db.env <- read.env.proc(file.path(".",ENV_DIR,'proc-env.csv'))
db.env <- db.env %>% filter(series %in% SELECTED_TMS)
```

```{r}
db.env <- db.env %>% filter(ts >= ts_start & ts <= ts_end)
summary(db.env)
```

```{r}
# sampling.dates <- data.frame(xdate = c(as.POSIXct('2022-05-04 00:00:00', tz = 'Europe/Madrid'),
#             as.POSIXct('2022-08-19 00:00:00', tz = 'Europe/Madrid'),
#             as.POSIXct('2022-11-24 00:00:00', tz = 'Europe/Madrid'),
#             as.POSIXct('2023-02-16 00:00:00', tz = 'Europe/Madrid'))
# ) # sampling dates Miedes and Peñaflor
sampling.dates <- data.frame(xdate = c(as.POSIXct('2022-05-19 00:00:00', tz = 'Europe/Madrid'),
            as.POSIXct('2022-08-22 00:00:00', tz = 'Europe/Madrid'),
            as.POSIXct('2022-11-16 00:00:00', tz = 'Europe/Madrid'),
            as.POSIXct('2023-02-20 00:00:00', tz = 'Europe/Madrid'))
) # sampling dates Corbalan
```


```{r}
plot_temp_and_humidity <-
  ggplot(data = db.env, aes(x=ts, y=soil.temp)) +
    ggtitle(glue("Soil temperature and humidity for {PLACE}")) +
    geom_line(aes(colour = soil.temp)) +
    scale_colour_gradient(low = "light blue", high = "red") +
    scale_x_datetime(date_breaks = "1 month", date_labels="%b %Y") +
    theme(axis.text.x = element_text(angle = 30, hjust=1)) +
    scale_y_continuous("Temperature (ºC)\n", breaks=seq(0,50,10), sec.axis = dup_axis(name = "Volumetric Water Content (%)\n" ))+
    geom_line(aes(x = ts, y = vwc * 100,  linetype = "Volumetric Water Content (%)"), col="blue", show.legend	= TRUE) +
    scale_linetype_manual(NULL, values = 1) +
    labs(x=expression(''), colour = "Soil Temperature (ºC)") +
    geom_vline(data=sampling.dates, xintercept=xdate, lty=2)
plot_temp_and_humidity
```

```{r}
ggsave(glue('output/request-Antonio-soil-sampling/soiltemp-{PLACE}-VWCytempAgg-alldata.png'), width = 15, height = 10)
```

```{r}
plot_temp_and_humidity <-
  ggplot(data = db.env, aes(x=ts, y=surface.temp)) +
    ggtitle(glue("Surface temperature and humidity for {PLACE}")) +
    geom_line(aes(colour = surface.temp)) +
    scale_colour_gradient(low = "light blue", high = "red") +
    scale_x_datetime(date_breaks = "1 month", date_labels="%b %Y") +
    theme(axis.text.x = element_text(angle = 30, hjust=1)) +
    scale_y_continuous("Temperature (ºC)\n", breaks=seq(0,50,10), sec.axis = dup_axis(name = "Volumetric Water Content (%)\n" ))+
    geom_line(aes(x = ts, y = vwc * 100,  linetype = "Volumetric Water Content (%)"), col="blue", show.legend	= TRUE) +
    scale_linetype_manual(NULL, values = 1) +
    labs(x=expression(''), colour = "Surface Temperature (ºC)") +
    geom_vline(data=sampling.dates, xintercept=xdate, lty=2)
plot_temp_and_humidity
```

```{r}
ggsave(glue('output/request-Antonio-soil-sampling/surfacetemp-{PLACE}-VWCytempAgg-alldata.png'), width = 15, height = 10)
```


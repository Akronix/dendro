---
title: "R Notebook"
output: html_notebook
---

```{r}
source('lib-dendro.R')
library(ggplot2)
library(tidyverse)
library(purrr)
library(glue)
library(gridExtra)
library(patchwork)
```

ggplot custom theme
```{r}
theme_set( theme_bw() +
          theme(
            axis.text=element_text(size=12),
            axis.title=element_text(size=14),
            plot.title = element_text(hjust = 0.5, face = "bold")
          ))
```


```{r}
TreeList <- read.table("TreeList.txt", header=T)

PLACE = 'Miedes'
DATA_DIR = glue('processed/{PLACE}-processed')
```

Load dataset:
```{r}
list_files <- list.files(file.path(".",DATA_DIR), pattern="*.csv$", full.names=TRUE)
db<-read.all.processed(list_files)
```
Define classes which each series belong to:
```{r}
Qi = TreeList %>% filter(class == "Quercus", series %in% unique(db$series)) %>% pull(series)
P_D = TreeList %>% filter(class == "D", series %in% unique(db$series)) %>% pull(series)
P_ND = TreeList %>% filter(class == "ND", series %in% unique(db$series)) %>% pull(series)
```

Prepare db
```{r}
db = db %>% mutate(
                  date = date(db$ts),
                  class = case_when(
                    series %in% Qi ~ factor("Quercus"),
                    series %in% P_D ~ factor("D"),
                    series %in% P_ND ~ factor("ND"),
                    TRUE ~ NA
                    )
                  ) %>%
            filter(!is.na(class))
db
```

# TWD
```{r}
db.twd <- db %>% summarise( mean_twd = mean(twd, na.rm = T), twd_se = sd(twd / sqrt(n()), na.rm = T), .by = c(date, class), n = as.integer(n() / 96)) %>% mutate(doy = yday(date))
db.twd2022 <- db.twd %>% filter(year(date) == 2022)
db.twd2023 <- db.twd %>% filter(year(date) == 2023)
db.twd
```

```{r}
Q_n <-  db.twd2023 %>% filter(class == "Quercus") %>% first() %>% select(n)
D_n <-  db.twd2023 %>% filter(class == "D") %>% first() %>% select(n)
ND_n <- db.twd2023 %>% filter(class == "ND") %>% first() %>% select(n)
```

```{r}
labels = c("Quercus", "Declining Pines", "Non-Declining Pines")
c_labels = c(glue("{labels[1]} ({Q_n})"), glue("{labels[2]} ({D_n})"), glue("{labels[3]} ({ND_n})"))
```

```{r}
plot.twd2023 <- db.twd2023 %>%
  ggplot () +
  geom_boxplot(aes (x = class, y = mean_twd, color = class)) +
  scale_color_discrete(labels = c_labels) +
  labs(title = glue("Boxplot of TWD dispersion for 2023 by classes - {PLACE}"), x = "Class", y = "Tree Water Deficit") +
  scale_x_discrete(labels=c("Q" = labels[1], "D" = labels[2],
                              "ND" = labels[3]))
plot.twd2022 <- db.twd2022 %>%
  ggplot () +
  geom_boxplot(aes (x = class, y = mean_twd, color = class)) +
  scale_color_discrete(labels = c_labels) +
  labs(title = glue("Boxplot of TWD dispersion for 2022 by classes - {PLACE}"), x = "Class", y = "Tree Water Deficit") +
  scale_x_discrete(labels=c("Q" = labels[1], "D" = labels[2],
                              "ND" = labels[3]))
grid_output1 <- grid.arrange(plot.twd2022, plot.twd2023, ncol = 2)
combined <- plot.twd2022 + plot.twd2023 + plot_layout(guides = "collect") & theme(legend.position = "bottom")
```
```{r}
ggsave(glue('output/TWD-byClass-{PLACE}.png'), combined, width = 22, height = 10)
```


# GRO
```{r}
db.gro <- db %>% summarise( gro = mean(gro_yr, na.rm = T), gro_se = sd(gro_yr / sqrt(n()), na.rm = T), .by = c(date, class)) %>% mutate(doy = yday(date))
db.gro2022 <- db.gro %>% filter(year(date) == 2022)
db.gro2023 <- db.gro %>% filter(year(date) == 2023)
db.gro
```

```{r}
plotgro2023 <- db.gro2023 %>% ggplot () +
  ggtitle(glue('Acumulated Growth for 2023 - {PLACE}')) +
  geom_line(aes (x = doy, y = gro, color = class)) +
  geom_line(aes (x = doy, y = (gro + gro_se), color = class), alpha = 0.5, linetype = "dashed") +
  geom_line(aes (x = doy, y = (gro - gro_se), color = class), alpha = 0.5, linetype = "dashed") +
  labs(x = "Day of the year", y = expression(paste("Acumulated growth (",mu, "m)")) ) +
  scale_color_discrete(labels = c_labels)

plotgro2022 <- db.gro2022 %>% 
  ggplot() +
  ggtitle(glue('Acumulated growth for 2022 - {PLACE}')) +
  geom_line(aes (x = doy, y = gro, color = class)) +
  geom_line(aes (x = doy, y = (gro + gro_se), color = class), alpha = 0.5, linetype = "dashed") +
  geom_line(aes (x = doy, y = (gro - gro_se), color = class), alpha = 0.5, linetype = "dashed") +
  labs(x = "Day of the year", y = expression(paste("Acumulated growth (",mu, "m)")) ) +
  scale_color_discrete(labels = c_labels)

grid_output <- grid.arrange(plotgro2022, plotgro2023, nrow = 2)
grid_output
```

```{r}
ggsave(glue('output/GRO-byClass-{PLACE}.png'), grid_output, width = 15, height = 10)
```

